<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prévisualisation du CV</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: #f5f5f5;
        padding: 20px;
      }

      .actions {
        max-width: 900px;
        margin: 0 auto 20px;
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: #2563eb;
        color: white;
      }

      .btn-primary:hover {
        background: #1d4ed8;
      }

      .btn-secondary {
        background: #6b7280;
        color: white;
      }

      .btn-secondary:hover {
        background: #4b5563;
      }

      #cv-container {
        max-width: 8.5in; /* Largeur du papier letter */
        height: 11in; /* Hauteur fixe du papier letter */
        max-height: 11in;
        margin: 0 auto;
        background: white;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }

      /* Styles pour tous les templates */
      .template-moderne,
      .template-classique,
      .template-minimal,
      .template-securite {
        height: 11in; /* Hauteur fixe */
        width: 100%;
        box-sizing: border-box;
        position: relative;
        overflow: hidden;
      }

      /* Styles pour le template Moderne */
      .template-moderne {
        font-family: "Helvetica Neue", Arial, sans-serif;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 11in;
      }

      .template-moderne .header {
        background: #2563eb;
        color: white;
        padding: 25px 30px; /* Réduit de 30px 40px */
        text-align: center;
        flex-shrink: 0;
      }

      .template-moderne .header h1 {
        font-size: 28px; /* Réduit de 32px */
        margin-bottom: 8px;
      }

      .template-moderne .contact-info {
        font-size: 13px; /* Réduit de 14px */
        opacity: 0.9;
      }

      .template-moderne .content {
        padding: 20px 30px; /* Réduit de 30px 40px */
        overflow-y: auto;
        flex: 1;
      }

      .template-moderne .section {
        margin-bottom: 18px; /* Réduit de 25px */
        padding-bottom: 10px; /* Réduit de 15px */
        border-bottom: 1px solid #e5e7eb;
      }

      .template-moderne .section:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }

      .template-moderne h2 {
        color: #2563eb;
        font-size: 18px; /* Réduit de 20px */
        margin: 0 0 8px; /* Réduit de 10px */
        display: flex;
        align-items: center;
      }

      .template-moderne h2:before {
        content: "▶";
        margin-right: 8px;
        font-size: 12px; /* Réduit de 14px */
      }

      .template-moderne p {
        line-height: 1.4; /* Réduit de 1.5 */
        margin-bottom: 6px; /* Réduit de 8px */
        color: #333;
        font-size: 13px; /* Réduit de 14px */
      }

      /* Styles pour le template Classique */
      .template-classique {
        font-family: Georgia, "Times New Roman", serif;
        display: flex;
        height: 11in;
        position: relative;
        overflow: hidden;
      }

      .template-classique .sidebar {
        background: #f3f4f6;
        width: 230px; /* Réduit de 250px */
        padding: 25px 20px; /* Réduit de 30px 25px */
        border-right: 2px solid #ddd;
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        height: 100%;
        overflow-y: auto;
      }

      .template-classique .sidebar h2 {
        font-size: 14px; /* Réduit de 16px */
        margin: 18px 0 6px; /* Réduit */
        color: #333;
        border-bottom: 1px solid #999;
        padding-bottom: 4px;
      }

      .template-classique .sidebar h2:first-child {
        margin-top: 0;
      }

      .template-classique .sidebar p {
        font-size: 12px; /* Réduit de 13px */
        line-height: 1.4;
        margin-bottom: 5px;
      }

      .template-classique .main {
        margin-left: 230px; /* Ajusté */
        padding: 25px; /* Réduit de 30px */
        height: 100%;
        overflow-y: auto;
      }

      .template-classique .main h1 {
        font-size: 26px; /* Réduit de 28px */
        color: #222;
        margin-bottom: 12px;
        border-bottom: 3px double #000;
        padding-bottom: 8px;
      }

      .template-classique .section {
        background: #fafafa;
        padding: 12px; /* Réduit de 15px */
        margin-bottom: 12px; /* Réduit de 15px */
        border: 1px solid #e5e7eb;
        border-radius: 4px;
      }

      .template-classique .section h2 {
        font-size: 16px; /* Réduit de 18px */
        margin: 0 0 6px;
        color: #333;
        font-style: italic;
      }

      .template-classique p {
        line-height: 1.4;
        margin-bottom: 5px;
        color: #444;
        font-size: 13px; /* Réduit de 14px */
      }

      /* Styles pour le template Minimal */
      .template-minimal {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        padding: 30px 40px; /* Réduit de 40px 50px */
        max-width: 800px;
        margin: 0 auto;
        height: 11in;
        overflow-y: auto;
      }

      .template-minimal h1 {
        font-size: 24px; /* Réduit de 26px */
        font-weight: 300;
        margin-bottom: 12px;
        text-align: center;
      }

      .template-minimal .contact-line {
        text-align: center;
        color: #666;
        margin-bottom: 25px; /* Réduit de 30px */
        font-size: 12px; /* Réduit de 13px */
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }

      .template-minimal .section {
        margin-bottom: 20px; /* Réduit de 25px */
      }

      .template-minimal h2 {
        font-size: 13px; /* Réduit de 14px */
        font-weight: 600;
        margin: 0 0 6px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #333;
        position: relative;
        padding-left: 12px;
      }

      .template-minimal h2:before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 5px;
        height: 5px;
        background: #333;
        border-radius: 50%;
      }

      .template-minimal p {
        line-height: 1.5; /* Réduit de 1.6 */
        color: #555;
        margin-bottom: 6px; /* Réduit de 8px */
        padding-left: 12px;
        font-size: 12px; /* Réduit de 13px */
      }

      /* Styles pour le template Sécurité */
      .template-securite {
        font-family: Arial, sans-serif;
        display: flex;
        height: 11in;
        position: relative;
        overflow: hidden;
      }

      .template-securite .sidebar {
        background: #1e3a8a;
        color: white;
        width: 200px; /* Encore plus réduit */
        padding: 15px 10px; /* Padding minimal */
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        height: 11in; /* Hauteur fixe exacte */
        overflow: hidden; /* Changé de overflow-y: auto */
        font-size: 10px;
      }

      .template-securite .agent-icon {
        width: 50px; /* TRÈS réduit */
        height: 50px;
        margin: 0 auto 10px; /* TRÈS réduit */
        background: rgba(255, 255, 255, 0.15);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .template-securite .agent-icon::after {
        content: "";
        position: absolute;
        width: 60px; /* TRÈS réduit */
        height: 60px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        top: -5px;
        left: -5px;
      }

      .template-securite .agent-icon span {
        font-size: 25px; /* TRÈS réduit */
      }

      .template-securite .sidebar h2 {
        font-size: 11px; /* TRÈS réduit */
        margin: 12px 0 4px; /* TRÈS réduit */
        text-transform: uppercase;
        letter-spacing: 0.3px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        padding-bottom: 2px;
      }

      .template-securite .sidebar p {
        font-size: 9px; /* TRÈS réduit */
        line-height: 1.3;
        opacity: 0.9;
        margin-bottom: 3px;
        word-wrap: break-word;
      }

      .template-securite .main {
        margin-left: 200px; /* Ajusté pour correspondre */
        padding: 15px; /* TRÈS réduit */
        background: white;
        height: 11in; /* Hauteur fixe */
        overflow: hidden; /* Empêche le débordement */
      }

      .template-securite .main h1 {
        font-size: 22px; /* TRÈS réduit */
        color: #1e3a8a;
        margin-bottom: 2px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }

      .template-securite .main .title {
        color: #666;
        font-size: 12px; /* TRÈS réduit */
        margin-bottom: 15px; /* TRÈS réduit */
        font-style: italic;
      }

      .template-securite .section {
        background: #f8f9fa;
        border-left: 4px solid #1e3a8a;
        padding: 8px; /* TRÈS réduit */
        margin-bottom: 10px; /* TRÈS réduit */
        border-radius: 0 6px 6px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .template-securite .section h2 {
        font-size: 13px; /* TRÈS réduit */
        color: #1e3a8a;
        margin: 0 0 5px 0;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }

      .template-securite .section p {
        line-height: 1.3; /* TRÈS réduit */
        color: #333;
        margin-bottom: 4px; /* TRÈS réduit */
        font-size: 11px; /* TRÈS réduit */
      }

      /* Fix spécifique pour Chrome - empêche le débordement */
      @media print {
        /* FORCE L'IMPRESSION DES COULEURS DE FOND */
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          color-adjust: exact !important;
        }

        body {
          background: white;
          padding: 0;
          margin: 0;
        }

        .actions {
          display: none !important;
        }

        #cv-container {
          box-shadow: none;
          max-width: 8.5in !important;
          width: 8.5in !important;
          height: 11in !important;
          margin: 0;
          padding: 0;
          overflow: hidden !important;
          page-break-after: avoid !important;
        }

        /* Force une seule page avec marges Chrome */
        @page {
          size: letter;
          margin: 0;
        }

        /* Fix Chrome pour éviter page vide */
        .template-securite {
          width: 8.5in !important;
          height: 11in !important;
          max-height: 11in !important;
          overflow: hidden !important;
          position: relative !important;
          page-break-inside: avoid !important;
          page-break-after: avoid !important;
        }

        .template-securite .sidebar {
          position: absolute !important;
          left: 0 !important;
          top: 0 !important;
          width: 190px !important;
          height: 11in !important;
          max-height: 11in !important;
          overflow: hidden !important;
          padding: 10px !important;
          background-color: #1e3a8a !important;
          -webkit-print-color-adjust: exact !important;
        }

        .template-securite .main {
          position: absolute !important;
          left: 190px !important;
          top: 0 !important;
          width: calc(8.5in - 190px) !important;
          height: 11in !important;
          max-height: 11in !important;
          overflow: hidden !important;
          padding: 12px !important;
          background-color: white !important;
        }

        /* Force les couleurs de fond pour chaque template */
        .template-moderne .header {
          background-color: #2563eb !important;
          -webkit-print-color-adjust: exact !important;
        }

        .template-classique .sidebar {
          background-color: #f3f4f6 !important;
          -webkit-print-color-adjust: exact !important;
        }

        .template-securite .section {
          background-color: #f8f9fa !important;
          -webkit-print-color-adjust: exact !important;
        }

        .template-securite .agent-icon {
          background-color: rgba(255, 255, 255, 0.15) !important;
          -webkit-print-color-adjust: exact !important;
        }

        /* Empêcher toute coupure de page */
        .template-moderne,
        .template-classique,
        .template-minimal {
          page-break-inside: avoid !important;
          page-break-after: avoid !important;
          height: 11in !important;
          max-height: 11in !important;
          overflow: hidden !important;
        }

        /* Réduction supplémentaire des tailles de police pour l'impression */
        .template-securite p {
          font-size: 9px !important;
        }
        .template-securite h2 {
          font-size: 11px !important;
        }
        .template-securite h1 {
          font-size: 20px !important;
        }
        .template-securite .title {
          font-size: 11px !important;
        }
        .template-securite .section {
          padding: 5px !important;
          margin-bottom: 6px !important;
        }
        .template-securite .agent-icon {
          width: 40px !important;
          height: 40px !important;
          margin-bottom: 8px !important;
        }
        .template-securite .agent-icon span {
          font-size: 20px !important;
        }

        /* Force la hauteur maximale */
        #cv-container {
          height: 11in !important;
          max-height: 11in !important;
          overflow: hidden !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="actions">
      <button class="btn btn-secondary" onclick="goBack()">← Retour</button>
      <button class="btn btn-secondary" onclick="window.print()">
        🖨️ Imprimer
      </button>
      <button class="btn btn-primary" onclick="exportPDF()">
        📄 Télécharger en PDF
      </button>
    </div>

    <div
      id="notification"
      style="
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 15px 25px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
      "
    >
      ✓ PDF généré avec succès!
    </div>

    <div id="cv-container">
      <!-- Le contenu du CV sera injecté ici -->
    </div>

    <script>
      // Charger les données depuis localStorage
      const cvData = JSON.parse(localStorage.getItem("cvData") || "{}");
      const selectedTemplate =
        localStorage.getItem("selectedTemplate") || "moderne";

      // Vérifier si les données sont présentes
      if (!cvData.nom) {
        document.getElementById("cv-container").innerHTML = `
        <div style="padding: 40px; text-align: center;">
          <p style="color: #dc2626; font-size: 18px;">Erreur : Aucune donnée trouvée.</p>
          <p style="margin-top: 10px;">Veuillez remplir le formulaire d'abord.</p>
          <button class="btn btn-primary" onclick="goBack()" style="margin-top: 20px;">Retour au formulaire</button>
        </div>
      `;
      } else {
        // Générer le CV selon le template sélectionné
        generateCV();
      }

      function generateCV() {
        let cvHTML = "";

        switch (selectedTemplate) {
          case "moderne":
            cvHTML = `
            <div class="template-moderne">
              <div class="header">
                <h1>${cvData.nom}</h1>
                <div class="contact-info">
                  ${cvData.email} | ${cvData.telephone}
                  ${cvData.adresse ? " | " + cvData.adresse : ""}
                </div>
              </div>
              <div class="content">
                ${
                  cvData.resume
                    ? `<div class="section"><h2>Résumé professionnel</h2><p>${cvData.resume}</p></div>`
                    : ""
                }
                ${
                  cvData.experience
                    ? `<div class="section"><h2>Expérience professionnelle</h2><p>${cvData.experience.replace(
                        /\n/g,
                        "<br>"
                      )}</p></div>`
                    : ""
                }
                ${
                  cvData.education
                    ? `<div class="section"><h2>Éducation</h2><p>${cvData.education.replace(
                        /\n/g,
                        "<br>"
                      )}</p></div>`
                    : ""
                }
                ${
                  cvData.certifications
                    ? `<div class="section"><h2>Certifications</h2><p>${cvData.certifications.replace(
                        /\n/g,
                        "<br>"
                      )}</p></div>`
                    : ""
                }
                ${
                  cvData.competences
                    ? `<div class="section"><h2>Compétences</h2><p>${cvData.competences}</p></div>`
                    : ""
                }
                ${
                  cvData.langues
                    ? `<div class="section"><h2>Langues</h2><p>${cvData.langues}</p></div>`
                    : ""
                }
              </div>
            </div>
          `;
            break;

          case "classique":
            cvHTML = `
            <div class="template-classique">
              <div class="sidebar">
                <h2>Coordonnées</h2>
                <p><strong>Courriel :</strong><br>${cvData.email}</p>
                <p><strong>Tél. :</strong><br>${cvData.telephone}</p>
                ${
                  cvData.adresse
                    ? `<p><strong>Adresse :</strong><br>${cvData.adresse}</p>`
                    : ""
                }
                
                ${
                  cvData.langues
                    ? `<h2>Langues</h2><p>${cvData.langues}</p>`
                    : ""
                }
                ${
                  cvData.competences
                    ? `<h2>Compétences</h2><p>${cvData.competences.replace(
                        /,/g,
                        "<br>"
                      )}</p>`
                    : ""
                }
              </div>
              <div class="main">
                <h1>${cvData.nom}</h1>
                ${
                  cvData.resume
                    ? `<div class="section"><h2>Résumé professionnel</h2><p>${cvData.resume}</p></div>`
                    : ""
                }
                ${
                  cvData.experience
                    ? `<div class="section"><h2>Expérience professionnelle</h2><p>${cvData.experience.replace(
                        /\n/g,
                        "<br>"
                      )}</p></div>`
                    : ""
                }
                ${
                  cvData.education
                    ? `<div class="section"><h2>Éducation</h2><p>${cvData.education.replace(
                        /\n/g,
                        "<br>"
                      )}</p></div>`
                    : ""
                }
                ${
                  cvData.certifications
                    ? `<div class="section"><h2>Certifications</h2><p>${cvData.certifications.replace(
                        /\n/g,
                        "<br>"
                      )}</p></div>`
                    : ""
                }
              </div>
            </div>
          `;
            break;

          case "minimal":
            cvHTML = `
            <div class="template-minimal">
              <h1>${cvData.nom}</h1>
              <div class="contact-line">
                ${cvData.email} • ${cvData.telephone}${
              cvData.adresse ? " • " + cvData.adresse : ""
            }
              </div>
              ${
                cvData.resume
                  ? `<div class="section"><h2>Résumé</h2><p>${cvData.resume}</p></div>`
                  : ""
              }
              ${
                cvData.experience
                  ? `<div class="section"><h2>Expérience</h2><p>${cvData.experience.replace(
                      /\n/g,
                      "<br>"
                    )}</p></div>`
                  : ""
              }
              ${
                cvData.education
                  ? `<div class="section"><h2>Éducation</h2><p>${cvData.education.replace(
                      /\n/g,
                      "<br>"
                    )}</p></div>`
                  : ""
              }
              ${
                cvData.certifications
                  ? `<div class="section"><h2>Certifications</h2><p>${cvData.certifications.replace(
                      /\n/g,
                      "<br>"
                    )}</p></div>`
                  : ""
              }
              ${
                cvData.competences
                  ? `<div class="section"><h2>Compétences</h2><p>${cvData.competences}</p></div>`
                  : ""
              }
              ${
                cvData.langues
                  ? `<div class="section"><h2>Langues</h2><p>${cvData.langues}</p></div>`
                  : ""
              }
            </div>
          `;
            break;

          case "securite":
            cvHTML = `
            <div class="template-securite">
              <div class="sidebar">
                <div class="agent-icon">
                  <span>👮</span>
                </div>
                
                <h2>Contact</h2>
                <p>${cvData.email}</p>
                <p>${cvData.telephone}</p>
                ${cvData.adresse ? `<p>${cvData.adresse}</p>` : ""}
                
                ${
                  cvData.certifications
                    ? `<h2>Certifications</h2><p>${cvData.certifications.replace(
                        /\n/g,
                        "<br>"
                      )}</p>`
                    : ""
                }
                ${
                  cvData.langues
                    ? `<h2>Langues</h2><p>${cvData.langues}</p>`
                    : ""
                }
                ${
                  cvData.competences
                    ? `<h2>Compétences</h2><p>${cvData.competences.replace(
                        /,/g,
                        "<br>"
                      )}</p>`
                    : ""
                }
              </div>
              <div class="main">
                <h1>${cvData.nom}</h1>
                <div class="title">Agent de Sécurité Professionnel</div>
                
                ${
                  cvData.resume
                    ? `<div class="section"><h2>Profil</h2><p>${cvData.resume}</p></div>`
                    : ""
                }
                ${
                  cvData.experience
                    ? `<div class="section"><h2>Expérience en Sécurité</h2><p>${cvData.experience.replace(
                        /\n/g,
                        "<br>"
                      )}</p></div>`
                    : ""
                }
                ${
                  cvData.education
                    ? `<div class="section"><h2>Formation</h2><p>${cvData.education.replace(
                        /\n/g,
                        "<br>"
                      )}</p></div>`
                    : ""
                }
              </div>
            </div>
          `;
            break;
        }

        document.getElementById("cv-container").innerHTML = cvHTML;
      }

      function goBack() {
        window.location.href = "cv-builder.html";
      }

      function exportPDF(btnEl) {
        const element = document.getElementById("cv-container");

        // Be resilient even if no event is passed
        const btn =
          btnEl ||
          document.activeElement ||
          document.querySelector(".actions .btn.btn-primary");
        const originalText = btn ? btn.textContent : null;
        if (btn) {
          btn.textContent = "Génération en cours...";
          btn.disabled = true;
        }

        const opt = {
          margin: 0.2,
          filename: `CV_${
            JSON.parse(localStorage.getItem("cvData") || "{}").nom || "document"
          }.pdf`,
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: {
            scale: 2,
            useCORS: true,
            letterRendering: true,
            scrollX: 0,
            scrollY: 0,
            onclone: (doc) => {
              // 1) Let everything expand and be visible in the clone
              const cv = doc.getElementById("cv-container");
              if (cv) {
                cv.style.overflow = "visible";
                cv.style.height = "auto";
                cv.style.maxHeight = "none";
              }

              // 2) Neutralize fixed heights/scrolls inside templates
              doc
                .querySelectorAll(
                  ".template-moderne, .template-classique, .template-minimal, .template-securite"
                )
                .forEach((el) => {
                  el.style.height = "auto";
                  el.style.maxHeight = "none";
                  el.style.overflow = "visible";
                  el.style.position = "static"; // safer for canvas layout
                });

              // 3) Unscroll content areas so full content renders
              doc
                .querySelectorAll(".content, .main, .sidebar")
                .forEach((el) => {
                  el.style.overflow = "visible";
                  el.style.height = "auto";
                  el.style.maxHeight = "none";
                });
            },
          },
          jsPDF: {
            unit: "in",
            format: "letter",
            orientation: "portrait",
            compress: true,
          },
          pagebreak: { mode: ["css", "legacy"] }, // allow automatic pagination if needed
        };

        html2pdf()
          .set(opt)
          .from(element)
          .save()
          .then(() => {
            if (btn && originalText) {
              btn.textContent = originalText;
              btn.disabled = false;
            }
            const notification = document.getElementById("notification");
            notification.style.display = "block";
            setTimeout(() => (notification.style.display = "none"), 3000);
          })
          .catch(() => {
            if (btn && originalText) {
              btn.textContent = originalText;
              btn.disabled = false;
            }
          });
      }
    </script>
  </body>
</html>
